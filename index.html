<!DOCTYPE html>
<html lang="en" class="govuk-template">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#0b0c0c">
  <title>PMQs Intelligence Briefing — No.10 Downing Street</title>
  <style>
    /* ── GDS DESIGN SYSTEM ───────────────────────────── */
    :root {
      --black:   #0b0c0c;
      --header-bg: #0b0c0c;
      --white:   #ffffff;
      --blue:    #1d70b8;
      --blue-dk: #003078;
      --green:   #00703c;
      --green-dk:#005a30;
      --red:     #d4351c;
      --yellow:  #ffdd00;
      --orange:  #f47738;
      --grey1:   #626a6e;
      --grey2:   #b1b4b6;
      --grey3:   #f3f2f1;
      --border:  #b1b4b6;
      --font: Arial, sans-serif;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { font-size: 16px; }
    body { font-family: var(--font); font-size: 1rem; line-height: 1.5; color: var(--black); background: #f8f8f8; -webkit-font-smoothing: antialiased; }

    /* Focus */
    *:focus { outline: 3px solid var(--yellow); outline-offset: 0; background-color: var(--yellow); color: var(--black); box-shadow: 0 -2px var(--yellow), 0 4px var(--black); }
    *:focus:not(:focus-visible) { outline: none; background: none; box-shadow: none; color: inherit; }

    /* Skip link */
    .skip-link { position: absolute; top: -999px; left: -999px; background: var(--yellow); color: var(--black); font-weight: 700; padding: 10px 15px; text-decoration: none; z-index: 999; }
    .skip-link:focus { top: 0; left: 0; }

    /* Restricted banner */
    .restricted-bar { background: var(--red); color: var(--white); text-align: center; padding: 7px 15px; font-size: 0.875rem; font-weight: 700; letter-spacing: 0.04em; }

    /* Header */
    .govuk-header { background: #2c2b2b; border-bottom: 10px solid var(--white); }
    .govuk-header__inner { max-width: 960px; margin: 0 auto; padding: 0 15px; display: flex; align-items: center; justify-content: space-between; height: 60px; }
    .govuk-header__logo { display: flex; align-items: center; gap: 10px; text-decoration: none; }
    .govuk-header__crown { width: 36px; height: 32px; fill: var(--white); flex-shrink: 0; }
    .govuk-header__logotype-text { color: var(--white); font-size: 1.5rem; font-weight: 700; line-height: 1; }
    .govuk-header__service { color: var(--white); font-size: 1rem; font-weight: 400; text-decoration: none; }
    .govuk-header__service:hover { text-decoration: underline; }

    /* Phase banner */
    .phase-banner-wrap { background: var(--white); border-bottom: 1px solid var(--border); }
    .phase-banner { max-width: 960px; margin: 0 auto; padding: 10px 15px; display: flex; align-items: center; gap: 10px; }
    .govuk-tag { display: inline-block; padding: 2px 8px; font-size: 0.875rem; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; color: var(--white); background: var(--blue); }
    .govuk-tag--red    { background: var(--red); }
    .govuk-tag--green  { background: var(--green); }
    .govuk-tag--orange { background: var(--orange); }
    .govuk-tag--grey   { background: var(--grey1); }
    .phase-text { font-size: 0.875rem; }

    /* Breadcrumbs */
    .breadcrumbs-wrap { max-width: 960px; margin: 0 auto; padding: 10px 15px 0; }
    .govuk-breadcrumbs__list { list-style: none; display: flex; flex-wrap: wrap; gap: 4px; }
    .govuk-breadcrumbs__list-item { font-size: 0.875rem; }
    .govuk-breadcrumbs__list-item + .govuk-breadcrumbs__list-item::before { content: "›"; margin-right: 4px; color: var(--grey1); }
    .govuk-breadcrumbs__link { color: var(--blue); }

    /* Layout */
    .govuk-width-container { max-width: 960px; margin: 0 auto; padding: 0 15px; }
    main { padding: 30px 0 60px; background: #f8f8f8; }
    .grid { display: grid; grid-template-columns: 400px 1fr; gap: 30px; align-items: start; }
    .panel { background: #ffffff; padding: 25px 30px; border: 1px solid #b1b4b6; }
    .card-panel { background: var(--white); padding: 25px; border: 1px solid var(--border); }

    /* Typography */
    .govuk-caption-l { font-size: 1.25rem; font-weight: 400; color: var(--grey1); margin-bottom: 5px; }
    .govuk-heading-xl { font-size: 2.5rem; font-weight: 700; line-height: 1.04; margin-bottom: 15px; color: var(--black); }
    .govuk-heading-l  { font-size: 1.875rem; font-weight: 700; line-height: 1.09; margin-bottom: 20px; }
    .govuk-heading-m  { font-size: 1.25rem; font-weight: 700; line-height: 1.15; margin-bottom: 10px; }
    .govuk-heading-s  { font-size: 1.1rem; font-weight: 700; line-height: 1.31; margin-bottom: 10px; }
    .govuk-body       { font-size: 1.1rem; line-height: 1.5; margin-bottom: 20px; }
    .govuk-body-s     { font-size: 1rem; line-height: 1.4; }
    .govuk-hint       { font-size: 1rem; line-height: 1.25; color: var(--grey1); margin-bottom: 10px; }

    /* Form */
    .govuk-form-group { margin-bottom: 20px; }
    .govuk-form-group--error { border-left: 5px solid var(--red); padding-left: 15px; }
    .govuk-label { display: block; font-size: 1.1rem; font-weight: 700; margin-bottom: 5px; color: var(--black); }
    .govuk-error-message { display: none; font-size: 1rem; font-weight: 700; color: var(--red); margin-bottom: 5px; }
    .govuk-form-group--error .govuk-error-message { display: block; }

    .govuk-textarea,
    .govuk-input,
    .govuk-select {
      font-family: var(--font);
      font-size: 1.1rem;
      line-height: 1.31;
      width: 100%;
      padding: 5px;
      border: 2px solid var(--black);
      border-radius: 0;
      color: var(--black);
      background: var(--white);
      -webkit-appearance: none;
      appearance: none;
    }
    .govuk-textarea { min-height: 150px; resize: vertical; }
    .govuk-textarea:focus, .govuk-input:focus, .govuk-select:focus { outline: 3px solid var(--yellow); outline-offset: 0; box-shadow: inset 0 0 0 2px; }
    .govuk-select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='17' height='10' viewBox='0 0 17 10'%3E%3Cpath fill='%230b0c0c' d='M8.5 10L0 0h17z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      padding-right: 34px;
    }

    /* Input grid */
    .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0 20px; }

    /* Radios */
    .govuk-fieldset__legend { font-size: 1.1rem; font-weight: 700; margin-bottom: 10px; display: block; }
    .govuk-radios--inline { display: flex; flex-wrap: wrap; gap: 5px 20px; }
    .govuk-radios__item { display: flex; align-items: center; position: relative; min-height: 40px; padding: 0 15px 0 54px; margin-bottom: 5px; cursor: pointer; }
    .govuk-radios--inline .govuk-radios__item { margin-bottom: 0; }
    .govuk-radios__input { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 34px; height: 34px; margin: 0; cursor: pointer; opacity: 0; z-index: 1; }
    .govuk-radios__label { font-size: 1.1rem; cursor: pointer; padding: 5px 0; margin-bottom: 0; }
    .govuk-radios__label::before { content: ''; position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 34px; height: 34px; border: 2px solid var(--black); border-radius: 50%; background: var(--white); }
    .govuk-radios__label::after  { content: ''; position: absolute; left: 17px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; border-radius: 50%; background: var(--black); opacity: 0; }
    .govuk-radios__input:checked + .govuk-radios__label::after { opacity: 1; }
    .govuk-radios__input:focus + .govuk-radios__label::before { outline: 3px solid var(--yellow); box-shadow: 0 0 0 4px var(--yellow); }

    /* Button */
    .govuk-button {
      font-family: var(--font);
      font-size: 1.1rem;
      font-weight: 700;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 12px 9px;
      border: 2px solid transparent;
      border-radius: 0;
      color: var(--white);
      background: var(--green);
      box-shadow: 0 2px 0 var(--green-dk);
      cursor: pointer;
      text-decoration: none;
      -webkit-appearance: none;
      width: 100%;
      margin-top: 10px;
    }
    .govuk-button:hover { background: var(--green-dk); }
    .govuk-button:focus { background: var(--yellow); color: var(--black); box-shadow: 0 2px 0 var(--black); outline: none; }
    .govuk-button:active { top: 2px; box-shadow: none; position: relative; }
    .govuk-button[disabled] { opacity: 0.5; cursor: default; }
    .govuk-button__spinner { display: none; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.4); border-top-color: #fff; border-radius: 50%; animation: spin 0.6s linear infinite; flex-shrink: 0; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Status */
    .status-panel { display: flex; align-items: center; gap: 12px; padding: 12px 15px; background: var(--grey3); border-left: 5px solid var(--border); margin-bottom: 20px; font-size: 1rem; }
    .status-panel--loading { border-left-color: var(--blue); }
    .status-panel--success { border-left-color: var(--green); background: #f0fff4; }
    .status-panel--error   { border-left-color: var(--red);   background: #fff5f5; }
    .status-dot { width: 12px; height: 12px; border-radius: 50%; background: var(--border); flex-shrink: 0; }
    .status-dot--loading { background: var(--blue); animation: pulse 1s ease-in-out infinite; }
    .status-dot--success { background: var(--green); }
    .status-dot--error   { background: var(--red); }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

    /* Empty state */
    .briefing-empty { padding: 40px 20px; text-align: center; color: var(--grey1); border: 2px dashed var(--border); }

    /* Output sections */
    .briefing-section { border-bottom: 1px solid var(--border); padding: 20px 0; }
    .briefing-section:last-child { border-bottom: none; }
    .briefing-section__label { font-size: 0.875rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--grey1); margin-bottom: 8px; }
    .briefing-section__text { font-size: 1.1rem; line-height: 1.5; }

    /* Inset text */
    .govuk-inset-text { border-left: 10px solid var(--grey2); padding: 15px; margin: 0; font-size: 1.1rem; line-height: 1.5; }
    .govuk-inset-text--blue { border-left-color: var(--blue); background: #f0f4fc; }

    /* List */
    .govuk-list { list-style: none; padding: 0; margin: 0; }
    .govuk-list--bullet li { padding-left: 20px; position: relative; margin-bottom: 6px; font-size: 1.1rem; line-height: 1.5; }
    .govuk-list--bullet li::before { content: "—"; position: absolute; left: 0; color: var(--grey1); }

    /* Confidence bar */
    .conf-track { width: 100%; height: 10px; background: var(--grey3); border: 1px solid var(--border); margin-bottom: 6px; }
    .conf-fill { height: 100%; background: var(--green); transition: width 0.8s ease; width: 0%; }
    .conf-fill--medium { background: var(--orange); }
    .conf-fill--low    { background: var(--red); }

    /* Meta grid */
    .meta-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

    /* Warning */
    .govuk-warning-text { display: flex; align-items: flex-start; gap: 12px; font-size: 1.1rem; font-weight: 700; padding: 10px 0; margin-bottom: 20px; }
    .govuk-warning-text__icon { display: flex; align-items: center; justify-content: center; width: 35px; height: 35px; min-width: 35px; border: 3px solid var(--black); border-radius: 50%; font-size: 1.2rem; font-weight: 700; }

    /* Details */
    .govuk-details { margin-bottom: 0; font-size: 1rem; }
    .govuk-details__summary { cursor: pointer; color: var(--blue); font-weight: 700; list-style: none; padding: 5px 0; }
    .govuk-details__summary::-webkit-details-marker { display: none; }
    .govuk-details__summary::before { content: "▶ "; font-size: 0.7em; }
    details[open] .govuk-details__summary::before { content: "▼ "; }
    .govuk-details__text { padding: 10px 0 0; }

    /* Footer */
    .govuk-footer { font-size: 1rem; padding: 25px 0; border-top: 1px solid var(--border); background: var(--grey3); margin-top: 40px; }
    .govuk-footer__inner { max-width: 960px; margin: 0 auto; padding: 0 15px; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 20px; }
    .govuk-footer__licence { font-size: 0.875rem; color: var(--grey1); }
    .govuk-footer__copyright { font-size: 0.875rem; text-align: right; }

    /* Responsive */
    @media (max-width: 768px) {
      .grid { grid-template-columns: 1fr; }
      .govuk-heading-xl { font-size: 1.875rem; }
      .input-grid { grid-template-columns: 1fr; }
      .meta-grid { grid-template-columns: 1fr; }
      .govuk-radios--inline { flex-direction: column; }
    }
  </style>
</head>
<body class="govuk-template__body">

<a href="#main-content" class="skip-link">Skip to main content</a>

<div class="restricted-bar" role="alert">⚠ RESTRICTED — INTERNAL USE ONLY — NO.10 DOWNING STREET — NOT FOR DISTRIBUTION</div>

<header class="govuk-header" role="banner">
  <div class="govuk-header__inner">
    <a href="/" class="govuk-header__logo" aria-label="GOV.UK">
      <svg class="govuk-header__crown" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 132 97" aria-hidden="true" focusable="false">
        <path fill="#ffffff" fill-rule="evenodd" d="M25 30.2c3.5 1.5 7.7-.2 9.1-3.7 1.5-3.6-.2-7.8-3.9-9.2-3.6-1.4-7.6.3-9.1 3.9-1.4 3.5.3 7.5 3.9 9zM9 39.5c3.6 1.5 7.8-.2 9.2-3.7 1.5-3.6-.3-7.8-3.9-9.1-3.6-1.5-7.6.2-9.1 3.8-1.4 3.5.3 7.5 3.8 9zM4.4 57.2c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.5-1.5-7.6.3-9.1 3.8-1.4 3.5.3 7.6 3.9 9.1zm38.3-21.4c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.6-1.5-7.6.3-9.1 3.8-1.3 3.6.4 7.7 3.9 9.1zm64.4-5.6c-3.6 1.5-7.8-.2-9.1-3.7-1.5-3.6.2-7.8 3.8-9.2 3.6-1.4 7.7.3 9.2 3.9 1.3 3.5-.4 7.5-3.9 9zm15.9 9.3c-3.6 1.5-7.7-.2-9.1-3.7-1.5-3.6.2-7.8 3.7-9.1 3.6-1.5 7.7.2 9.2 3.8 1.5 3.5-.3 7.5-3.8 9zm4.7 17.7c-3.6 1.5-7.8-.2-9.2-3.8-1.5-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.3 3.5-.4 7.6-3.9 9.1zM89.3 35.8c-3.6 1.5-7.8-.2-9.2-3.8-1.4-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.4 3.6-.3 7.7-3.9 9.1zM69.7 17.7l8.9 4.7V9.3l-8.9 2.8c-.2-.3-.5-.6-.9-.9L72.4 0H59.6l3.5 11.2c-.3.3-.6.5-.9.9l-8.8-2.8v13.1l8.8-4.7c.3.3.6.7.9.9l-5 15.4v.1h-4.1l-4.9-15.7c-.3-.3-.6-.6-.9-.9l-8.9 4.7V9.3l-8.8-2.8L4.4 17.7h65.3zm-52.1 57s0-14.3 0-14.5c0-2.1.9-2.6 2.1-2.6h61.1c1.2 0 2.1.5 2.1 2.6v14.5h.9c2.2 0 3.8 1.8 3.8 4 0 2.4-1.6 4.2-3.8 4.2H13.7c-2.2 0-3.9-1.8-3.9-4.2 0-2.2 1.7-4 3.9-4h.9z"/>
      </svg>
      <span class="govuk-header__logotype-text">GOV.UK</span>
    </a>
    <a href="#" class="govuk-header__service">PMQs Intelligence System</a>
  </div>
</header>

<div class="phase-banner-wrap">
  <div class="phase-banner govuk-width-container">
    <span class="govuk-tag govuk-tag--red">RESTRICTED</span>
    <p class="phase-text">This is an internal Cabinet Office prototype. All outputs must be verified by a senior policy adviser before use.</p>
  </div>
</div>

<div class="govuk-width-container">
  <nav class="breadcrumbs-wrap" aria-label="Breadcrumb">
    <ol class="govuk-breadcrumbs__list">
      <li class="govuk-breadcrumbs__list-item"><a class="govuk-breadcrumbs__link" href="#">No.10 Downing Street</a></li>
      <li class="govuk-breadcrumbs__list-item"><a class="govuk-breadcrumbs__link" href="#">Cabinet Office Digital</a></li>
      <li class="govuk-breadcrumbs__list-item">PMQs Intelligence</li>
    </ol>
  </nav>
</div>

<div class="govuk-width-container">
  <main id="main-content" role="main">

    <div style="margin-bottom:30px;margin-top:20px">
      <p class="govuk-caption-l">Wednesday PMQs preparation</p>
      <h1 class="govuk-heading-xl">PMQs Intelligence Briefing</h1>
      <p class="govuk-body">Submit an MP question to generate a research-backed PM briefing. Powered by GPT-4.1 and Tavily web search across government sources.</p>
    </div>

    <div class="grid">

      <!-- ── FORM ────────────────────────────────── -->
      <div class="panel">
        <form id="briefingForm" novalidate onsubmit="return false">

          <div class="govuk-form-group" id="fg-question">
            <label class="govuk-label" for="question">
              MP question text
            </label>
            <div class="govuk-hint" id="question-hint">Enter the full question or anticipated line of attack</div>
            <div class="govuk-error-message" id="question-error">Enter the question text</div>
            <textarea class="govuk-textarea" id="question" name="question" rows="5" aria-describedby="question-hint"></textarea>
          </div>

          <div class="input-grid">
            <div class="govuk-form-group">
              <label class="govuk-label" for="mp_name">MP name</label>
              <input class="govuk-input" type="text" id="mp_name" name="mp_name" autocomplete="off">
            </div>
            <div class="govuk-form-group">
              <label class="govuk-label" for="constituency">Constituency</label>
              <input class="govuk-input" type="text" id="constituency" name="constituency" autocomplete="off">
            </div>
          </div>

          <div class="input-grid">
            <div class="govuk-form-group">
              <label class="govuk-label" for="party">Party</label>
              <select class="govuk-select" id="party" name="party">
                <option value="">Select</option>
                <option>Labour</option>
                <option>Conservative</option>
                <option>Liberal Democrat</option>
                <option>SNP</option>
                <option>Reform UK</option>
                <option>Plaid Cymru</option>
                <option>Green</option>
                <option>DUP</option>
                <option>Independent</option>
                <option>Other</option>
              </select>
            </div>
            <div class="govuk-form-group">
              <label class="govuk-label" for="domain">Policy domain</label>
              <select class="govuk-select" id="domain" name="domain">
                <option value="">Select</option>
                <option>NHS</option>
                <option>Economy</option>
                <option>Education</option>
                <option>Defence</option>
                <option>Crime</option>
                <option>Housing</option>
                <option>Farming</option>
                <option>Social Care</option>
                <option>Parliament</option>
                <option>Immigration</option>
                <option>Energy</option>
                <option>Transport</option>
                <option>Other</option>
              </select>
            </div>
          </div>

          <div class="govuk-form-group">
            <fieldset>
              <legend class="govuk-fieldset__legend">Priority</legend>
              <div class="govuk-radios govuk-radios--inline">
                <div class="govuk-radios__item">
                  <input class="govuk-radios__input" id="p-urgent" name="priority" type="radio" value="Urgent">
                  <label class="govuk-radios__label" for="p-urgent">Urgent</label>
                </div>
                <div class="govuk-radios__item">
                  <input class="govuk-radios__input" id="p-high" name="priority" type="radio" value="High">
                  <label class="govuk-radios__label" for="p-high">High</label>
                </div>
                <div class="govuk-radios__item">
                  <input class="govuk-radios__input" id="p-normal" name="priority" type="radio" value="Normal" checked>
                  <label class="govuk-radios__label" for="p-normal">Normal</label>
                </div>
                <div class="govuk-radios__item">
                  <input class="govuk-radios__input" id="p-low" name="priority" type="radio" value="Low">
                  <label class="govuk-radios__label" for="p-low">Low</label>
                </div>
              </div>
            </fieldset>
          </div>

          <button class="govuk-button" id="submitBtn" type="button" onclick="submitQuestion()">
            <span class="govuk-button__spinner" id="spinner"></span>
            <span id="btnText">Generate PM briefing</span>
          </button>

          <p class="govuk-hint" style="margin-top:8px">Press Ctrl+Enter to submit</p>

        </form>
      </div>

      <!-- ── OUTPUT ──────────────────────────────── -->
      <div class="panel">

        <div class="status-panel" id="statusPanel" role="status" aria-live="polite">
          <div class="status-dot" id="statusDot"></div>
          <span class="govuk-body-s" id="statusText" style="margin:0">Awaiting question submission</span>
        </div>

        <div class="briefing-empty" id="emptyState">
          <p class="govuk-body" style="margin:0;color:var(--grey1)">Complete the form and click Generate PM briefing.<br>The intelligence brief will appear here.</p>
        </div>

        <div id="briefingOutput" style="display:none" aria-live="polite">

          <div class="govuk-warning-text" id="sec-restricted" style="display:none">
            <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
            <strong>Restricted — PM eyes only — not for external distribution</strong>
          </div>

          <div class="briefing-section" id="sec-threat" style="display:none">
            <p class="briefing-section__label">Threat assessment</p>
            <p class="briefing-section__text" id="val-threat"></p>
          </div>

          <div class="briefing-section" id="sec-answer" style="display:none">
            <p class="briefing-section__label">Suggested PM response</p>
            <div class="govuk-inset-text govuk-inset-text--blue">
              <p class="govuk-body" id="val-answer" style="margin:0"></p>
            </div>
          </div>

          <div class="briefing-section" id="sec-lines-take" style="display:none">
            <p class="briefing-section__label">Lines to take</p>
            <ul class="govuk-list govuk-list--bullet" id="val-lines-take"></ul>
          </div>

          <div class="briefing-section" id="sec-lines-avoid" style="display:none">
            <p class="briefing-section__label">Lines to avoid</p>
            <ul class="govuk-list govuk-list--bullet" id="val-lines-avoid"></ul>
          </div>

          <div class="briefing-section" id="sec-facts" style="display:none">
            <p class="briefing-section__label">Key facts</p>
            <ul class="govuk-list govuk-list--bullet" id="val-facts"></ul>
          </div>

          <div class="briefing-section" id="sec-meta" style="display:none">
            <div class="meta-grid">
              <div>
                <p class="briefing-section__label">Confidence score</p>
                <div class="conf-track" role="progressbar" aria-valuemin="0" aria-valuemax="100" id="confBar">
                  <div class="conf-fill" id="confFill"></div>
                </div>
                <p class="govuk-body-s" id="confNum" style="font-weight:700"></p>
              </div>
              <div>
                <p class="briefing-section__label">FOI risk</p>
                <span class="govuk-tag" id="foiBadge">—</span>
                <p class="govuk-body-s" id="foiText" style="margin-top:8px;color:var(--grey1)"></p>
              </div>
            </div>
            <div style="margin-top:15px">
              <p class="briefing-section__label">Policy domain</p>
              <span class="govuk-tag govuk-tag--grey" id="domainBadge">—</span>
            </div>
          </div>

          <div class="briefing-section" id="sec-sources" style="display:none">
            <details class="govuk-details">
              <summary class="govuk-details__summary">Sources used in this briefing</summary>
              <div class="govuk-details__text">
                <ul class="govuk-list" id="val-sources" style="font-size:0.9rem;color:var(--blue)"></ul>
              </div>
            </details>
          </div>

          <div class="briefing-section" id="sec-raw" style="display:none">
            <p class="briefing-section__label">Raw output</p>
            <div class="govuk-inset-text" style="font-size:0.875rem;font-family:monospace;white-space:pre-wrap" id="val-raw"></div>
          </div>

        </div>
      </div>

    </div>
  </main>
</div>

<footer class="govuk-footer" role="contentinfo">
  <div class="govuk-footer__inner">
    <div class="govuk-footer__licence">
      <p>PMQs Intelligence System · Cabinet Office Internal Prototype</p>
      <p style="margin-top:5px">All outputs must be verified by a senior policy adviser before use at the despatch box</p>
    </div>
    <div class="govuk-footer__copyright">
      <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 483.2 195.7" height="17" width="41" style="display:block;margin-left:auto;margin-bottom:4px">
        <path fill="currentColor" d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 170.7 97c0 .4 0 .8.1 1.2 0 .4-.1.8-.1 1.2 0 .4 0 .8.1 1.2 0 13.9 3 27 8.3 38.9L138 165.4 150.8 178l37.2-37.2c15.7 17.5 38.5 28.5 63.9 28.5A98 98 0 0 0 350.5 120l-42.7-27.2a47.08 47.08 0 0 1-8.6 40zM122.4 93.1c0-26 21.1-47.1 47.1-47.1h.6l-3.3-48.1A97.77 97.77 0 0 0 24.9 97.1a97.63 97.63 0 0 0 25.3 65.6l.6-.6 42.5-42.6c-1.1-3.7-1.7-7.6-1.7-11.6-.1-8.2 2-15.8 5.8-22.8z"/>
      </svg>
      <p>© Crown copyright</p>
    </div>
  </div>
</footer>

<script>
  function setStatus(state, text) {
    const panel = document.getElementById('statusPanel');
    const dot   = document.getElementById('statusDot');
    const label = document.getElementById('statusText');
    panel.className = 'status-panel' + (state ? ' status-panel--' + state : '');
    dot.className   = 'status-dot'   + (state ? ' status-dot--'   + state : '');
    label.textContent = text;
  }

  function extractSection(text, heading) {
    const r = new RegExp(heading + ':?\\s*([\\s\\S]*?)(?=\\n[A-Z][A-Z\\s]+:|$)', 'i');
    const m = text.match(r);
    if (!m) return null;
    return m[1].replace(/^[-•*]\s+.*/gm, '').trim() || null;
  }
  function extractBullets(text, heading) {
    const r = new RegExp(heading + ':?\\s*([\\s\\S]*?)(?=\\n[A-Z][A-Z\\s]+:|$)', 'i');
    const m = text.match(r);
    if (!m) return [];
    return m[1].split('\n').map(l => l.replace(/^[-•*\d.]+\s*/, '').trim()).filter(l => l.length > 2);
  }
  function extractInline(text, heading) {
    const m = text.match(new RegExp(heading + ':?\\s*(.+)', 'i'));
    return m ? m[1].trim() : null;
  }
  function show(id) { document.getElementById(id).style.display = ''; }
  function renderText(secId, valId, content) {
    if (!content) return;
    show(secId);
    document.getElementById(valId).textContent = content.trim();
  }
  function renderBullets(secId, valId, items) {
    if (!items || !items.length) return;
    show(secId);
    const ul = document.getElementById(valId);
    ul.innerHTML = '';
    items.forEach(item => { const li = document.createElement('li'); li.textContent = item; ul.appendChild(li); });
  }

  function parseAndRender(output) {
    document.getElementById('emptyState').style.display = 'none';
    show('briefingOutput');
    const text = typeof output === 'string' ? output : JSON.stringify(output, null, 2);
    const s = {
      threat:     extractSection(text, 'THREAT ASSESSMENT'),
      answer:     extractSection(text, 'SUGGESTED PM RESPONSE'),
      linesTake:  extractBullets(text, 'LINES TO TAKE'),
      linesAvoid: extractBullets(text, 'LINES TO AVOID'),
      facts:      extractBullets(text, 'KEY FACTS'),
      confidence: extractInline(text,  'CONFIDENCE SCORE'),
      sources:    extractBullets(text, 'SOURCES'),
      foi:        extractInline(text,  'FOI RISK'),
      domain:     extractInline(text,  'DOMAIN'),
    };
    show('sec-restricted');
    if (s.answer || s.threat || s.facts.length) {
      renderText('sec-threat', 'val-threat', s.threat);
      renderText('sec-answer', 'val-answer', s.answer);
      renderBullets('sec-lines-take',  'val-lines-take',  s.linesTake);
      renderBullets('sec-lines-avoid', 'val-lines-avoid', s.linesAvoid);
      renderBullets('sec-facts',       'val-facts',       s.facts);
      renderBullets('sec-sources',     'val-sources',     s.sources);
      if (s.confidence || s.foi || s.domain) {
        show('sec-meta');
        const score = parseInt(s.confidence) || 0;
        const fill  = document.getElementById('confFill');
        fill.style.width = score + '%';
        fill.className = 'conf-fill' + (score >= 70 ? '' : score >= 40 ? ' conf-fill--medium' : ' conf-fill--low');
        document.getElementById('confBar').setAttribute('aria-valuenow', score);
        document.getElementById('confNum').textContent = score + ' out of 100';
        const foiRaw   = s.foi || '';
        const foiLevel = (foiRaw.match(/High|Medium|Low/i)?.[0] || '').toLowerCase();
        const badge = document.getElementById('foiBadge');
        badge.textContent = foiLevel ? foiLevel[0].toUpperCase() + foiLevel.slice(1) : (foiRaw || '—');
        badge.className = 'govuk-tag' +
          (foiLevel === 'high' ? ' govuk-tag--red' : foiLevel === 'medium' ? ' govuk-tag--orange' : foiLevel === 'low' ? ' govuk-tag--green' : '');
        document.getElementById('foiText').textContent = foiRaw.replace(/^(High|Medium|Low)\s*[—–\-]?\s*/i, '');
        document.getElementById('domainBadge').textContent = s.domain || '—';
      }
    } else {
      show('sec-raw');
      document.getElementById('val-raw').textContent = text;
    }
  }

  async function submitQuestion() {
    const question     = document.getElementById('question').value.trim();
    const mp_name      = document.getElementById('mp_name').value.trim();
    const constituency = document.getElementById('constituency').value.trim();
    const party        = document.getElementById('party').value;
    const domain       = document.getElementById('domain').value;
    const priority     = document.querySelector('input[name="priority"]:checked')?.value || 'Normal';

    const fg = document.getElementById('fg-question');
    if (!question) {
      fg.classList.add('govuk-form-group--error');
      document.getElementById('question').focus();
      return;
    }
    fg.classList.remove('govuk-form-group--error');

    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    document.getElementById('spinner').style.display = 'block';
    document.getElementById('btnText').textContent = 'Researching and drafting…';
    setStatus('loading', 'Contacting research API — please wait…');

    document.getElementById('briefingOutput').style.display = 'none';
    document.getElementById('emptyState').style.display = '';
    ['sec-restricted','sec-threat','sec-answer','sec-lines-take','sec-lines-avoid','sec-facts','sec-meta','sec-sources','sec-raw'].forEach(id => {
      document.getElementById(id).style.display = 'none';
    });

    try {
      const res = await fetch('https://arie08.app.n8n.cloud/webhook/pmqs-brief', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question, mp_name, constituency, party, domain, priority })
      });
      if (!res.ok) throw new Error('Server returned ' + res.status);
      const data = await res.json();
      setStatus('success', 'Briefing ready · ' + (mp_name || 'MP') + ' · ' + new Date().toLocaleTimeString('en-GB'));
      parseAndRender(data.output ?? data);
    } catch (err) {
      setStatus('error', 'Error: ' + err.message);
      document.getElementById('emptyState').style.display = 'none';
      show('briefingOutput');
      show('sec-raw');
      document.getElementById('val-raw').textContent = 'Request failed: ' + err.message;
    } finally {
      btn.disabled = false;
      document.getElementById('spinner').style.display = 'none';
      document.getElementById('btnText').textContent = 'Generate PM briefing';
    }
  }

  document.addEventListener('keydown', e => { if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') submitQuestion(); });
</script>
</body>
</html>
